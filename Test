package Game;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.URISyntaxException;
import java.nio.file.*;
import java.util.ArrayList;
import java.util.Collections;
import static javafx.scene.paint.Color.color;
import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.Clip;
import javax.sound.sampled.DataLine;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.UnsupportedAudioFileException;
import org.jsfml.system.*;
import org.jsfml.window.*;
import org.jsfml.window.event.*;
import org.jsfml.graphics.*;

/**
 * A playable demo of our game Freefall.
 * @author 210 Group
 */
public class Freefall {

    private static final int screenWidth = 1024;
    private static final int screenHeight = 768;
    private static final String JavaVersion
            = Runtime.class.getPackage().getImplementationVersion();
    private static final String JdkFontPath
            = "C:\\Program Files\\Java\\jdk" + JavaVersion
            + "\\jre\\lib\\fonts\\";
    private static final String JreFontPath
            = "C:\\Program Files\\Java\\jre" + JavaVersion
            + "\\lib\\fonts\\";
    private static final int fontSize = 48;
    private static final String FontFile = "LucidaSansRegular.ttf";
    private static final String Title = "FreeFall";
    private static final String Message = "Round and round...";
    private String FontPath;
    private final ArrayList<Actor> actors = new ArrayList<>();

    private final Texture backgroundImage, blockLnRImage, blockMidImage, blockSmallImage,
            borderImage, leaderBoardButtonImage, logoImage, optionsButtonImage,
            spriteImage, startButtonImage, blockLargeImage;
    
    private final AudioInputStream stream;
    //Produce a clip from input stream and loop continously
    private static void music(AudioInputStream stream) throws IOException, URISyntaxException, LineUnavailableException, UnsupportedAudioFileException {
        AudioFormat format = stream.getFormat();
        DataLine.Info info = new DataLine.Info(Clip.class, format);
        Clip clip = (Clip) AudioSystem.getLine(info);
        clip.open(stream);
        clip.loop(Clip.LOOP_CONTINUOUSLY);
    }

    Freefall() throws IOException, URISyntaxException, LineUnavailableException, UnsupportedAudioFileException {
        // obtain an input stream from .wav file        
        InputStream in = Freefall.class.getResourceAsStream("Resources/bensound-dance.wav");
        InputStream bufferedIn = new BufferedInputStream(in);
        // read the buffered stream into an AudioInputStream
        stream = AudioSystem.getAudioInputStream(bufferedIn);
        // produce clip
        music(stream);
        //Initialise texture
        //Get images as input stream to load texture from
        backgroundImage = new Texture();
        this.backgroundImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/Background.jpg"));
        blockLnRImage = new Texture();
        this.blockLnRImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/BlockLnR.jpg"));
        blockMidImage = new Texture();
        this.blockMidImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/BlockMid.jpg"));
        blockSmallImage = new Texture();
        this.blockSmallImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/BlockSmall.jpg"));
        borderImage = new Texture();
        this.borderImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/Border.jpg"));
        leaderBoardButtonImage = new Texture();
        this.leaderBoardButtonImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/LeaderboardButton.png"));
        logoImage = new Texture();
        this.logoImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/Logo.png"));
        optionsButtonImage = new Texture();
        this.optionsButtonImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/OptionsButton.png"));
        spriteImage = new Texture();
        this.spriteImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/Sprite.png"));
        startButtonImage = new Texture();
        this.startButtonImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/StartButton.png"));
        blockLargeImage = new Texture();
        this.blockLargeImage.loadFromStream(Freefall.class.getResourceAsStream("Resources/BlockLarge.jpg"));
    }
    //Any in game object
    private abstract class Actor {

        Transformable obj;
        int x = 0;
        int y = 0;
        int r = 0;
        int dx = 5;
        int dy = 5;

        boolean within(int x, int y) {
            return false;
        }

        void calcMove(int minx, int miny, int maxx, int maxy) {
            x += dx;
            y += dy;
            if (x <= minx || x >= maxx) {
                dx *= -1;
                x += dx;
            }
            if (y <= miny || y >= maxy) {
                dy *= -1;
                y += dy;
            }
            for (Actor a : actors) {
                if (a.obj != obj && a.within(x, y)) {
                    dx *= -1;
                    x += dx;
                    dy *= -1;
                    y += dy;
                }
            }
        }

        void performMove() {
            obj.rotate(r);
            obj.setPosition(x, y);
        }

        void draw(RenderWindow w) {
            w.draw((Drawable) obj);
        }
    }
    //Updatable text
    private class Message extends Actor {

        Text yo;

        public Message(int x, int y, int r, int dx, int dy, String message, Color c) throws IOException {
            //load font, set style
            Font sansRegular = new Font();
            sansRegular.loadFromFile(Paths.get(FontPath + FontFile));
            yo = new Text(message, sansRegular, fontSize);
            yo.setColor(c);
            yo.setStyle(Text.BOLD | Text.UNDERLINED);
            //position on screen
            FloatRect textBounds = yo.getLocalBounds();
            yo.setOrigin(textBounds.width / 2,
                    textBounds.height / 2);
            this.x = x;
            this.y = y;
            this.dx = dx;
            this.dy = dy;
            this.r = r;
            obj = yo;
        }
        //update message
        public void changeMessage(String message) {
            yo.setString(message);
        }
    }

    private class Image210 extends Actor {

        int countX = 0;
        int countY = 0;
        int checkY = 1;
        int checkX = 1;
        int neX = 0;
        int neY = 0;
        int size = 0;
        //Any game object with a texture
        public Image210(int x, int y, int r, int size, int dx, int dy, Texture imageFile) {
            //load texture from inputstream
            Texture imgTexture = imageFile;
            imgTexture.setSmooth(true);
            Sprite img = new Sprite(imgTexture);
            img.setOrigin(Vector2f.div(
                    new Vector2f(imgTexture.getSize()), 2));
            this.x = x;
            this.y = y;
            this.r = r;
            this.size = size;
            this.dx = dx;
            this.dy = dy;
            obj = img;
        }

        public void changeX(int x) {
            this.x = x;
        }

        public void changeY(int y) {
            this.y = y;
        }

        public void changeDy(int y) {
            this.dy = y;
        }

        public void changeDx(int x) {
            this.dx = x;
        }
    }

    /**
     *
     */
    ArrayList scores = new ArrayList();
    int scrCnt=0;
    public class GameOver {

        /**
         * Game Over Screen
         * @param score Score obtained by player
         * @throws TextureCreationException
         * @throws IOException
         */
        public void run(int score) throws TextureCreationException, IOException {
            Game newGame = new Game();
            RenderWindow window = new RenderWindow();
            window.create(new VideoMode(screenWidth, screenHeight), Title, WindowStyle.DEFAULT);
            window.setFramerateLimit(60);
            //Load images, add them to render window.
            Image210 startButton = new Image210(512, 388, 0, 0, 0, 0, startButtonImage);
            actors.add(new Image210(512, 384, 0, 0, 0, 0, backgroundImage));
            actors.add(new Message(512, 200, 0, 0, 0, "you scored: " + String.valueOf(score), Color.WHITE));
            actors.add(startButton);
            if(scrCnt>=3){
                scores.remove(2);
                scores.add(score);
                Collections.sort(scores, Collections.reverseOrder());
            }
            else {
                scores.add(score);
                Collections.sort(scores, Collections.reverseOrder());
                scrCnt++;
            }
            actors.add(new Message(512, 500, 0, 0, 0, "Top 3 Best Scores: " + String.valueOf(scores), Color.WHITE));
            actors.add(startButton);
            
            
            while (window.isOpen()) {
                window.clear(Color.WHITE);
                for (Actor actor : actors) {
                    actor.calcMove(0, 0, screenWidth, screenHeight);
                    actor.performMove();
                    actor.draw(window);
                }
                window.display();
                for (Event event : window.pollEvents()) {
                    if (event.type == Event.Type.CLOSED) {
                        System.exit(0);
                    }
                    if (event.type == Event.Type.MOUSE_BUTTON_PRESSED) {
                        Vector2i pos = Mouse.getPosition();
                        if (pos.x > 750 && pos.x < 1200 && pos.y > 520 && pos.y < 630) {
                            window.close();
                            newGame.run();
                        }
                    }
                }
            }
        }
    }

    /**
     * Main game window.
     */
    public class Game {

        private boolean wCan, aCan, sCan, dCan = true;
        private Image210[] things = new Image210[10];
        private Image210 sprite;
        private Message score;
        private int calc, speed;
        int pointff = 0;

        /**
         *  Update game objects
         */
        public void update() {
            pointff++;
            // Diffiuclty increase
            score.changeMessage(String.valueOf(pointff));
            if (pointff % 1000 == 0) {
                speed++;
                for (int i = 0; i < 10; i++) {
                    if (speed < 5) {
                        things[i].changeDy(speed);
                    }
                }
            }
            //Add and remove falling blocks
            for (int i = 0; i < 10; i++) {
                if (things[i].y > 760) {
                    actors.remove(things[i]);
                    things[i].changeY(0);
                    actors.add(things[i]);
                }
                //if sprite is intersecting with block
                if ((sprite.y > (things[i].y - 30) && sprite.y < (things[i].y + 30)) && ((sprite.x > (things[i].x - things[i].size)) && (sprite.x < (things[i].x + things[i].size)))) {
                    //Move outside collision zone, disable movement in blocked direction
                    if ((sprite.y > (things[i].y - 30) && sprite.y < (things[i].y + 30))) {
                        calc = sprite.y - things[i].y;
                        if (calc > 0) {
                            wCan = false;
                            sprite.changeY(things[i].y + 30);
                        } else {
                            sCan = false;
                            sprite.changeY(things[i].y - 30);
                        }
                    }
                }
            }
        }

        /**
         * Runs game window
         * @throws TextureCreationException
         * @throws IOException
         */
        public void run() throws TextureCreationException, IOException {
            RenderWindow window = new RenderWindow();
            window.create(new VideoMode(screenWidth, screenHeight), Title, WindowStyle.DEFAULT);
            speed = 1;
            int spriteSpeed = 12;
            //Creates game objects
            sprite = new Image210(512, 675, 0, 0, 0, 0, spriteImage);
            Image210 backG = new Image210(512, 384, 0, 0, 0, 0, backgroundImage);
            Image210 borderL = new Image210(128, 384, 0, 0, 0, 0, borderImage);
            Image210 borderR = new Image210(896, 384, 0, 0, 0, 0, borderImage);
            score = new Message(40, 50, 0, 0, 0, String.valueOf(pointff), Color.WHITE);
            things[0] = new Image210(477, 25, 0, 221, 0, 1, blockLnRImage);
            things[1] = new Image210(547, 125, 0, 221, 0, 1, blockLnRImage);
            things[2] = new Image210(477, 225, 0, 221, 0, 1, blockLnRImage);
            things[3] = new Image210(367, 625, 0, 110, 0, 1, blockMidImage);
            things[4] = new Image210(658, 625, 0, 110, 0, 1, blockMidImage);
            things[5] = new Image210(291, 325, 0, 60, 0, 1, blockSmallImage);
            things[6] = new Image210(597, 325, 0, 173, 0, 1, blockLargeImage);
            things[7] = new Image210(547, 525, 0, 221, 0, 1, blockLnRImage);
            things[8] = new Image210(712, 425, 0, 60, 0, 1, blockSmallImage);
            things[9] = new Image210(411, 425, 0, 173, 0, 1, blockLargeImage);
            GameOver game = new GameOver();
            //Adds them to window
            actors.add(backG);
            actors.add(sprite);
            actors.add(borderL);
            actors.add(borderR);
            actors.add(score);
            window.clear();
            for (int i = 0; i < 10; i++) {
                actors.add(things[i]);
            }
            while (window.isOpen()) {
                while (true) {
                    update();
                    //Collision with game borders
                    if (sprite.x < 260) {
                        sprite.changeDx(0);
                        sprite.changeX(260);
                        aCan = false;
                    } else {
                        aCan = true;
                    }
                    if (sprite.x > 763) {
                        sprite.changeDx(0);
                        sprite.changeX(763);
                        dCan = false;
                    } else {
                        dCan = true;
                    }
                    if (sprite.y < 10) {
                        sprite.changeDy(0);
                        sprite.changeY(10);
                        wCan = false;
                    } else {
                        wCan = true;
                    }
                    if (sprite.y > 745) {
                        sCan = false;
                        window.close();
                        game.run(pointff);
                    } else {
                        sCan = true;
                    }
                    for (Actor actor : actors) {
                        actor.calcMove(0, 0, screenWidth, screenHeight);
                        actor.performMove();
                        actor.draw(window);
                    }
                    window.display();
                    
                    for (Event event : window.pollEvents()) {
                        update();

                        if (event.type == Event.Type.CLOSED) {
                            System.exit(0);
                        }
                        //Directional movement controls
                        if (event.type == Event.Type.KEY_PRESSED) {
                            KeyEvent keyboard = event.asKeyEvent();
                            if (keyboard.key.equals(Keyboard.Key.valueOf("W")) && wCan) {
                                sprite.changeDy(-spriteSpeed);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("A")) && aCan) {
                                sprite.changeDx(-spriteSpeed);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("D")) && dCan) {
                                sprite.changeDx(spriteSpeed);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("S")) && sCan) {
                                sprite.changeDy(spriteSpeed);
                            }
                        }
                        if (event.type == Event.Type.KEY_RELEASED) {
                            KeyEvent keyboard = event.asKeyEvent();
                            if (keyboard.key.equals(Keyboard.Key.valueOf("W")) == false) {
                                sprite.changeDy(0);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("A")) == false) {
                                sprite.changeDx(0);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("D")) == false) {
                                sprite.changeDx(0);
                            }
                            if (keyboard.key.equals(Keyboard.Key.valueOf("S")) == false) {
                                sprite.changeDy(0);
                            }
                        }
                        for (Actor actor : actors) {
                            actor.calcMove(0, 0, screenWidth, screenHeight);
                            actor.performMove();
                            actor.draw(window);
                        }
                        window.display();
                    }
                }

            }
        }

    }

    private class StartMenu {

        Game gameBoard = new Game();

        public void run() throws TextureCreationException, IOException {
            RenderWindow window = new RenderWindow();
            window.create(new VideoMode(screenWidth, screenHeight), Title, WindowStyle.DEFAULT);
            window.setFramerateLimit(60);
            Image210 logo = new Image210(512, 150, 0, 0, 0, 0, logoImage);
            Image210 startButton = new Image210(512, 388, 0, 0, 0, 0, startButtonImage);
            Image210 Background = new Image210(512, 384, 0, 0, 0, 0, backgroundImage);

            while (window.isOpen()) {
                window.clear(Color.WHITE);
                actors.add(Background);
                actors.add(startButton);
                actors.add(logo);
                for (Actor actor : actors) {
                    actor.calcMove(0, 0, screenWidth, screenHeight);
                    actor.performMove();
                    actor.draw(window);
                }
                window.display();
                for (Event event : window.pollEvents()) {
                    //When window closed..
                    if (event.type == Event.Type.CLOSED) {
                        System.exit(0);
                    }
                    //Button parameters
                    if (event.type == Event.Type.MOUSE_BUTTON_PRESSED) {
                        Vector2i pos = Mouse.getPosition();
                        if (pos.x > 750 && pos.x < 1200 && pos.y > 520 && pos.y < 630) {
                            window.close();
                            gameBoard.run();
                        }
                    }
                }
            }
        }
    }

    /**
     * Starts program
     * @throws TextureCreationException
     * @throws IOException
     */
    public void run() throws TextureCreationException, IOException {
        if ((new File(JreFontPath)).exists()) {
            FontPath = JreFontPath;
        } else {
            FontPath = JdkFontPath;
        }

        StartMenu test = new StartMenu();
        test.run();
    }

    /**
     * Main method
     * @param args
     * @throws IOException
     * @throws TextureCreationException
     * @throws URISyntaxException
     * @throws LineUnavailableException
     * @throws UnsupportedAudioFileException
     */
    public static void main(String args[]) throws IOException, TextureCreationException, URISyntaxException, LineUnavailableException, UnsupportedAudioFileException {
        Freefall demo = new Freefall();
        demo.run();
    }
}
